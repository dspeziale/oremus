<!--
    COMPONENTE NAVIGAZIONE DATE OREMUS
    Inserire questo HTML nei template (lodi.html, vespri.html, etc)
    Fornisce: picker data, frecce precedente/successivo, salto a oggi
-->

<div class="date-navigator-container">
    <div class="date-navigator-header">
        <button class="btn-nav-date" id="btnPrevDay" title="Giorno Precedente">
            <i class="fas fa-chevron-left"></i> Precedente
        </button>

        <div class="date-display-wrapper">
            <input type="date" id="datePickerInput" class="date-picker-input" />
            <span class="date-display-text" id="dateDisplayText">
                <i class="fas fa-calendar-alt"></i>
                <span id="dateFormatted">Caricamento...</span>
            </span>
        </div>

        <button class="btn-nav-date" id="btnToday" title="Vai a Oggi">
            <i class="fas fa-calendar-check"></i> Oggi
        </button>

        <button class="btn-nav-date" id="btnNextDay" title="Giorno Successivo">
            Successivo <i class="fas fa-chevron-right"></i>
        </button>
    </div>

    <div class="mini-calendar" id="miniCalendar"></div>
</div>

<style>
.date-navigator-container {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    padding: 20px;
    border-radius: 10px;
    margin-bottom: 30px;
    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
}

.date-navigator-header {
    display: flex;
    gap: 15px;
    align-items: center;
    justify-content: center;
    flex-wrap: wrap;
    margin-bottom: 15px;
}

.btn-nav-date {
    background: rgba(255, 255, 255, 0.2);
    border: 2px solid rgba(255, 255, 255, 0.4);
    color: white;
    padding: 10px 16px;
    border-radius: 6px;
    cursor: pointer;
    font-weight: 600;
    transition: all 0.3s ease;
    display: flex;
    align-items: center;
    gap: 8px;
    font-size: 14px;
}

.btn-nav-date:hover {
    background: rgba(255, 255, 255, 0.3);
    border-color: rgba(255, 255, 255, 0.6);
    transform: translateY(-2px);
}

.btn-nav-date:active {
    transform: translateY(0);
}

.date-display-wrapper {
    position: relative;
    display: flex;
    align-items: center;
    gap: 10px;
}

.date-picker-input {
    display: none;
}

.date-display-text {
    background: rgba(255, 255, 255, 0.2);
    border: 2px solid rgba(255, 255, 255, 0.4);
    color: white;
    padding: 10px 20px;
    border-radius: 6px;
    cursor: pointer;
    font-weight: 600;
    display: flex;
    align-items: center;
    gap: 10px;
    transition: all 0.3s ease;
    font-size: 16px;
}

.date-display-text:hover {
    background: rgba(255, 255, 255, 0.3);
    border-color: rgba(255, 255, 255, 0.6);
}

/* Mini calendario */
.mini-calendar {
    background: rgba(255, 255, 255, 0.95);
    border-radius: 8px;
    padding: 15px;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    max-width: 350px;
    margin: 0 auto;
}

.mini-calendar-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 15px;
    font-weight: bold;
    color: #333;
}

.mini-calendar-nav {
    display: flex;
    gap: 10px;
}

.mini-calendar-nav button {
    background: #667eea;
    color: white;
    border: none;
    padding: 5px 10px;
    border-radius: 4px;
    cursor: pointer;
    font-size: 12px;
}

.mini-calendar-nav button:hover {
    background: #764ba2;
}

.calendar-grid {
    display: grid;
    grid-template-columns: repeat(7, 1fr);
    gap: 5px;
    text-align: center;
}

.calendar-weekday {
    font-weight: 600;
    color: #667eea;
    padding: 8px 0;
    font-size: 12px;
}

.calendar-day {
    padding: 8px;
    border-radius: 4px;
    cursor: pointer;
    font-size: 13px;
    transition: all 0.2s ease;
    color: #333;
}

.calendar-day:hover {
    background: #e0e7ff;
    font-weight: 600;
}

.calendar-day.other-month {
    color: #ccc;
    cursor: default;
}

.calendar-day.other-month:hover {
    background: transparent;
}

.calendar-day.today {
    background: #667eea;
    color: white;
    font-weight: bold;
    box-shadow: 0 2px 8px rgba(102, 126, 234, 0.3);
}

.calendar-day.today:hover {
    background: #764ba2;
}

.calendar-day.selected {
    background: #764ba2;
    color: white;
    font-weight: bold;
}

/* Responsive */
@media (max-width: 768px) {
    .date-navigator-header {
        flex-direction: column;
    }

    .btn-nav-date {
        width: 100%;
        justify-content: center;
    }

    .date-display-text {
        width: 100%;
        justify-content: center;
    }

    .mini-calendar {
        max-width: 100%;
    }
}
</style>

<script>
class DateNavigator {
    constructor() {
        this.currentDate = new Date();
        this.selectedDate = new Date();
        this.availableDates = window.allGiorni || [];
        this.init();
    }

    init() {
        this.setupEventListeners();
        this.updateDisplay();
        this.renderMiniCalendar();
    }

    setupEventListeners() {
        document.getElementById('btnPrevDay').addEventListener('click', () => this.previousDay());
        document.getElementById('btnNextDay').addEventListener('click', () => this.nextDay());
        document.getElementById('btnToday').addEventListener('click', () => this.goToToday());
        document.getElementById('dateDisplayText').addEventListener('click', () => this.toggleDatePicker());
        document.getElementById('datePickerInput').addEventListener('change', (e) => this.handleDateChange(e));
    }

    previousDay() {
        this.selectedDate.setDate(this.selectedDate.getDate() - 1);
        this.navigateToDate();
    }

    nextDay() {
        this.selectedDate.setDate(this.selectedDate.getDate() + 1);
        this.navigateToDate();
    }

    goToToday() {
        this.selectedDate = new Date();
        this.navigateToDate();
    }

    toggleDatePicker() {
        const picker = document.getElementById('datePickerInput');
        picker.click();
    }

    handleDateChange(e) {
        const dateStr = e.target.value;
        if (dateStr) {
            this.selectedDate = new Date(dateStr + 'T00:00:00');
            this.navigateToDate();
        }
    }

    navigateToDate() {
        const dateIso = this.getDateISO(this.selectedDate);
        const year = this.selectedDate.getFullYear();
        const month = String(this.selectedDate.getMonth() + 1).padStart(2, '0');
        const day = String(this.selectedDate.getDate()).padStart(2, '0');
        const urlDate = `${year}-${month}-${day}`;

        // Rileva quale sezione siamo (lodi, vespri, santi)
        const currentPath = window.location.pathname;
        const section = currentPath.split('/')[1];

        window.location.href = `/${section}/${urlDate}`;
    }

    updateDisplay() {
        const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
        const formatted = this.selectedDate.toLocaleDateString('it-IT', options);
        document.getElementById('dateFormatted').textContent = formatted;

        // Aggiorna l'input date
        const dateStr = this.getDateISO(this.selectedDate).replace(/(\d{4})(\d{2})(\d{2})/, '$1-$2-$3');
        document.getElementById('datePickerInput').value = dateStr;
    }

    renderMiniCalendar() {
        const year = this.currentDate.getFullYear();
        const month = this.currentDate.getMonth();

        const monthName = new Intl.DateTimeFormat('it-IT', { month: 'long', year: 'numeric' })
            .format(new Date(year, month));

        const firstDay = new Date(year, month, 1);
        const lastDay = new Date(year, month + 1, 0);
        const daysInMonth = lastDay.getDate();
        const startingDayOfWeek = firstDay.getDay();

        let html = `
            <div class="mini-calendar-header">
                <div class="mini-calendar-nav">
                    <button onclick="dateNavigator.previousMonth()">← Prev</button>
                </div>
                <div>${monthName}</div>
                <div class="mini-calendar-nav">
                    <button onclick="dateNavigator.nextMonth()">Next →</button>
                </div>
            </div>
            <div class="calendar-grid">
        `;

        // Giorni della settimana
        const weekdays = ['Dom', 'Lun', 'Mar', 'Mer', 'Gio', 'Ven', 'Sab'];
        weekdays.forEach(day => {
            html += `<div class="calendar-weekday">${day}</div>`;
        });

        // Giorni del mese precedente
        for (let i = 0; i < startingDayOfWeek; i++) {
            html += '<div class="calendar-day other-month"></div>';
        }

        // Giorni del mese corrente
        for (let day = 1; day <= daysInMonth; day++) {
            const date = new Date(year, month, day);
            const isToday = this.isToday(date);
            const isSelected = this.isSameDay(date, this.selectedDate);
            const className = isToday ? 'today' : (isSelected ? 'selected' : '');

            html += `
                <div class="calendar-day ${className}" onclick="dateNavigator.selectDate(${day})">
                    ${day}
                </div>
            `;
        }

        // Giorni del mese successivo
        const totalCells = Math.ceil((startingDayOfWeek + daysInMonth) / 7) * 7;
        for (let day = 1; day <= totalCells - (startingDayOfWeek + daysInMonth); day++) {
            html += '<div class="calendar-day other-month"></div>';
        }

        html += '</div>';
        document.getElementById('miniCalendar').innerHTML = html;
    }

    selectDate(day) {
        this.selectedDate = new Date(this.currentDate.getFullYear(), this.currentDate.getMonth(), day);
        this.navigateToDate();
    }

    previousMonth() {
        this.currentDate.setMonth(this.currentDate.getMonth() - 1);
        this.updateDisplay();
        this.renderMiniCalendar();
    }

    nextMonth() {
        this.currentDate.setMonth(this.currentDate.getMonth() + 1);
        this.updateDisplay();
        this.renderMiniCalendar();
    }

    getDateISO(date) {
        const year = date.getFullYear();
        const month = String(date.getMonth() + 1).padStart(2, '0');
        const day = String(date.getDate()).padStart(2, '0');
        return `${year}${month}${day}`;
    }

    isToday(date) {
        const today = new Date();
        return date.getDate() === today.getDate() &&
               date.getMonth() === today.getMonth() &&
               date.getFullYear() === today.getFullYear();
    }

    isSameDay(date1, date2) {
        return date1.getDate() === date2.getDate() &&
               date1.getMonth() === date2.getMonth() &&
               date1.getFullYear() === date2.getFullYear();
    }
}

// Inizializza quando il DOM è pronto
document.addEventListener('DOMContentLoaded', () => {
    window.dateNavigator = new DateNavigator();
});
</script>