{% extends "base.html" %}

{% block content %}
<div class="row">
	<div class="col-md-12">
		<div class="card">
			<div class="card-header">
				<div class="d-flex align-items-center">
					<h4 class="card-title mb-0">
						<i class="fas fa-users mr-2"></i>Gestione Utenti
					</h4>
					<a href="{{ url_for('add_user') }}" class="btn btn-primary btn-sm ml-auto">
						<i class="fas fa-plus mr-1"></i>Aggiungi Nuovo Utente
					</a>
				</div>
			</div>
			<div class="card-body">
				{% if users %}
				<div class="table-responsive">
					<table class="table table-hover table-striped">
						<thead>
							<tr>
								<th>ID</th>
								<th>Nome</th>
								<th>Email</th>
								<th>Ruolo</th>
								<th>Data Registrazione</th>
								<th>Azioni</th>
							</tr>
						</thead>
						<tbody>
							{% for user in users %}
							<tr>
								<td><strong>#{{ user.id }}</strong></td>
								<td>{{ user.nome }}</td>
								<td>{{ user.email }}</td>
								<td>
									{% if user.ruolo == 'admin' %}
										<span class="badge badge-danger">Amministratore</span>
									{% elif user.ruolo == 'moderator' %}
										<span class="badge badge-warning">Moderatore</span>
									{% else %}
										<span class="badge badge-primary">Utente</span>
									{% endif %}
								</td>
								<td>{{ user.data_registrazione }}</td>
								<td>
									<div class="btn-group btn-group-sm" role="group">
										<a href="{{ url_for('view_user', user_id=user.id) }}" class="btn btn-info" title="Visualizza">
											<i class="fas fa-eye"></i>
										</a>
										<a href="{{ url_for('edit_user', user_id=user.id) }}" class="btn btn-warning" title="Modifica">
											<i class="fas fa-edit"></i>
										</a>
										<button type="button" class="btn btn-danger" data-toggle="modal" data-target="#deleteModal" onclick="setDeleteId({{ user.id }})" title="Elimina">
											<i class="fas fa-trash"></i>
										</button>
									</div>
								</td>
							</tr>
							{% endfor %}
						</tbody>
					</table>
				</div>

				<!-- Pagination -->
				<nav aria-label="Page navigation" class="mt-3">
					<ul class="pagination">
						<li class="page-item"><a class="page-link" href="#">Precedente</a></li>
						<li class="page-item active"><a class="page-link" href="#">1</a></li>
						<li class="page-item"><a class="page-link" href="#">2</a></li>
						<li class="page-item"><a class="page-link" href="#">3</a></li>
						<li class="page-item"><a class="page-link" href="#">Successivo</a></li>
					</ul>
				</nav>
				{% else %}
				<div class="alert alert-info" role="alert">
					<i class="fas fa-info-circle mr-2"></i>
					Nessun utente trovato. <a href="{{ url_for('add_user') }}">Aggiungi il primo utente.</a>
				</div>
				{% endif %}
			</div>
		</div>
	</div>
</div>

<!-- Delete Confirmation Modal -->
<div class="modal fade" id="deleteModal" tabindex="-1" role="dialog" aria-labelledby="deleteModalLabel" aria-hidden="true">
	<div class="modal-dialog" role="document">
		<div class="modal-content">
			<div class="modal-header bg-danger">
				<h5 class="modal-title text-white" id="deleteModalLabel">Conferma Eliminazione</h5>
				<button type="button" class="close text-white" data-dismiss="modal" aria-label="Close">
					<span aria-hidden="true">&times;</span>
				</button>
			</div>
			<div class="modal-body">
				<p>Sei sicuro di voler eliminare questo utente?</p>
				<p class="text-muted"><small>Questa azione non pu√≤ essere annullata.</small></p>
			</div>
			<div class="modal-footer">
				<button type="button" class="btn btn-secondary" data-dismiss="modal">Annulla</button>
				<button type="button" class="btn btn-danger" onclick="deleteUser()">Elimina</button>
			</div>
		</div>
	</div>
</div>

<script>
	let userToDelete = null;

	function setDeleteId(userId) {
		userToDelete = userId;
	}

	function deleteUser() {
		if (userToDelete) {
			fetch(`/users/${userToDelete}/delete`, {
				method: 'POST',
				headers: {
					'Content-Type': 'application/json'
				}
			})
			.then(response => response.json())
			.then(data => {
				if (data.status === 'success') {
					alert('Utente eliminato con successo');
					location.reload();
				} else {
					alert('Errore: ' + data.message);
				}
			})
			.catch(error => {
				console.error('Errore:', error);
				alert('Errore durante l\'eliminazione');
			});
			$('#deleteModal').modal('hide');
		}
	}
</script>

<style>
	.table-hover tbody tr:hover {
		background-color: #f5f5f5;
	}

	.btn-group-sm .btn {
		padding: 4px 8px;
		font-size: 12px;
	}

	.badge {
		padding: 5px 10px;
	}
</style>
{% endblock %}