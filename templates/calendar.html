{% extends "base.html" %}

{% block title %}Calendario - Oremus{% endblock %}

{% block content %}

<h1 style="font-weight: 700; margin-bottom: 2rem; color: #0f172a;">
    <i class="fas fa-calendar-days" style="color: #6366f1;"></i> Calendario Liturgico
</h1>

<div class="row g-4">
    <!-- SIDEBAR -->
    <div class="col-lg-3">
        <!-- Ricerca -->
        <div class="card">
            <div class="card-header">
                <i class="fas fa-search"></i>
                <h5>Ricerca Data</h5>
            </div>
            <div class="card-body">
                <div class="mb-3">
                    <label class="form-label" for="dateInput">Seleziona data:</label>
                    <input type="date" id="dateInput" class="form-control">
                </div>
                <button class="btn btn-primary w-100" id="gotoDateBtn">
                    <i class="fas fa-arrow-right me-2"></i>Vai
                </button>

                <hr class="my-3">

                <h6 class="mb-2">Scorciatoie</h6>
                <div class="d-grid gap-2">
                    <button class="btn btn-outline-secondary btn-sm" id="todayBtn">
                        <i class="fas fa-calendar-day me-2"></i>Oggi
                    </button>
                    <button class="btn btn-outline-secondary btn-sm" id="tomorrowBtn">
                        <i class="fas fa-calendar me-2"></i>Domani
                    </button>
                    <button class="btn btn-outline-secondary btn-sm" id="nextWeekBtn">
                        <i class="fas fa-calendar me-2"></i>Prossima settimana
                    </button>
                </div>
            </div>
        </div>

        <!-- Stats -->
        <div class="card mt-3">
            <div class="card-header">
                <i class="fas fa-chart-bar"></i>
                <h5>Statistiche</h5>
            </div>
            <div class="card-body">
                <div id="statsContainer">
                    <div class="spinner-border spinner-border-sm" role="status">
                        <span class="visually-hidden">Caricamento...</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- MAIN CALENDAR -->
    <div class="col-lg-9">
        <div class="card">
            <div class="card-header">
                <i class="fas fa-calendar-alt"></i>
                <h5>Date Disponibili con Santo</h5>
            </div>
            <div class="card-body">
                <!-- Month Navigation -->
                <div class="row align-items-center mb-4">
                    <div class="col">
                        <button class="btn btn-outline-secondary btn-sm" id="prevMonthBtn">
                            <i class="fas fa-chevron-left me-2"></i>Precedente
                        </button>
                    </div>
                    <div class="col text-center">
                        <h5 id="currentMonth" style="margin: 0; font-weight: 600; color: #0f172a;"></h5>
                    </div>
                    <div class="col text-end">
                        <button class="btn btn-outline-secondary btn-sm" id="nextMonthBtn">
                            Successivo<i class="fas fa-chevron-right ms-2"></i>
                        </button>
                    </div>
                </div>

                <!-- Calendar Grid -->
                <div id="datesContainer">
                    <div class="text-center py-5">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Caricamento...</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
    .date-card {
        background: white;
        border: 1px solid #e5e7eb;
        border-radius: 8px;
        padding: 1.5rem;
        text-align: center;
        cursor: pointer;
        text-decoration: none;
        color: inherit;
        display: block;
        transition: all 0.3s ease;
    }

    .date-card:hover {
        background: linear-gradient(135deg, #6366f1 0%, #818cf8 100%);
        color: white;
        border-color: #6366f1;
        transform: translateY(-4px);
        box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
    }

    .date-card-day {
        font-size: 1.75rem;
        font-weight: 700;
        margin-bottom: 0.5rem;
    }

    .date-card-date {
        font-size: 0.85rem;
        opacity: 0.8;
        margin-bottom: 0.75rem;
    }

    .date-card-santo {
        font-size: 0.9rem;
        font-weight: 600;
        color: #dc2626;
        margin-top: 0.75rem;
        padding-top: 0.75rem;
        border-top: 1px solid rgba(0,0,0,0.1);
        line-height: 1.4;
    }

    .date-card:hover .date-card-santo {
        color: white;
        border-top-color: rgba(255,255,255,0.3);
    }
</style>

{% endblock %}

{% block extra_js %}
<script>
    let currentMonth = new Date().toISOString().slice(0, 7);

    function formatMonth(dateStr) {
        const date = new Date(dateStr + '-01');
        const options = { month: 'long', year: 'numeric' };
        return date.toLocaleDateString('it-IT', options).charAt(0).toUpperCase() +
               date.toLocaleDateString('it-IT', options).slice(1);
    }

    function loadDates(month) {
        currentMonth = month;
        document.getElementById('currentMonth').textContent = formatMonth(month);

        const container = document.getElementById('datesContainer');
        container.innerHTML = '<div class="text-center py-5"><div class="spinner-border spinner-border-sm" role="status"></div></div>';

        fetch(`/api/dates/${month}`)
            .then(res => res.json())
            .then(data => {
                let html = '<div class="row g-3">';

                if (!data.dates || data.dates.length === 0) {
                    html = '<div class="alert alert-info"><i class="fas fa-info-circle me-2"></i>Nessuna data disponibile. Esegui: <code>python orchestrate.py 20251020</code></div>';
                } else {
                    data.dates.forEach(item => {
                        const day = item.data.slice(6, 8);

                        // Estrai il santo dalla data_fmt
                        // Formato: "Lunedì 20 ottobre 2025: San Giorgio"
                        let dataStr = item.data_fmt.split(':')[0]; // "Lunedì 20 ottobre 2025"
                        let santo = '';

                        if (item.data_fmt.includes(':')) {
                            santo = item.data_fmt.split(':').slice(1).join(':').trim(); // "San Giorgio"
                        }

                        let santoHtml = '';
                        if (santo) {
                            santoHtml = `<div class="date-card-santo"><strong>:</strong> <i class="fas fa-cross me-1" style="color: #dc2626;"></i>${santo}</div>`;
                        }

                        html += `
                            <div class="col-md-6 col-lg-4">
                                <a href="/day/${item.data}" class="date-card">
                                    <div class="date-card-day">${day}</div>
                                    <div class="date-card-date">${dataStr}</div>
                                    ${santoHtml}
                                </a>
                            </div>
                        `;
                    });
                }

                html += '</div>';
                container.innerHTML = html;
            });
    }

    function loadStats() {
        document.getElementById('statsContainer').innerHTML = `
            <div style="font-size: 0.9rem;">
                <div class="mb-3 d-flex justify-content-between">
                    <span><i class="fas fa-calendar me-2" style="color: #6366f1;"></i>Date</span>
                    <strong>-</strong>
                </div>
                <div class="mb-3 d-flex justify-content-between">
                    <span><i class="fas fa-cross me-2" style="color: #ef4444;"></i>Santi</span>
                    <strong>-</strong>
                </div>
                <div class="mb-3 d-flex justify-content-between">
                    <span><i class="fas fa-sun me-2" style="color: #f59e0b;"></i>Lodi</span>
                    <strong>-</strong>
                </div>
                <div class="d-flex justify-content-between">
                    <span><i class="fas fa-moon me-2" style="color: #10b981;"></i>Vespri</span>
                    <strong>-</strong>
                </div>
            </div>
        `;
    }

    document.getElementById('dateInput').valueAsDate = new Date();

    document.getElementById('gotoDateBtn').addEventListener('click', () => {
        const date = document.getElementById('dateInput').value;
        if (date) window.location.href = `/day/${date.replace(/-/g, '')}`;
    });

    document.getElementById('todayBtn').addEventListener('click', () => {
        const today = new Date().toISOString().slice(0, 10);
        window.location.href = `/day/${today.replace(/-/g, '')}`;
    });

    document.getElementById('tomorrowBtn').addEventListener('click', () => {
        const tomorrow = new Date(Date.now() + 86400000).toISOString().slice(0, 10);
        window.location.href = `/day/${tomorrow.replace(/-/g, '')}`;
    });

    document.getElementById('nextWeekBtn').addEventListener('click', () => {
        const nextWeek = new Date(Date.now() + 7 * 86400000).toISOString().slice(0, 10);
        window.location.href = `/day/${nextWeek.replace(/-/g, '')}`;
    });

    document.getElementById('prevMonthBtn').addEventListener('click', () => {
        const [year, month] = currentMonth.split('-');
        let newMonth = parseInt(month) - 1;
        let newYear = parseInt(year);
        if (newMonth < 1) {
            newMonth = 12;
            newYear--;
        }
        loadDates(`${newYear}-${String(newMonth).padStart(2, '0')}`);
    });

    document.getElementById('nextMonthBtn').addEventListener('click', () => {
        const [year, month] = currentMonth.split('-');
        let newMonth = parseInt(month) + 1;
        let newYear = parseInt(year);
        if (newMonth > 12) {
            newMonth = 1;
            newYear++;
        }
        loadDates(`${newYear}-${String(newMonth).padStart(2, '0')}`);
    });

    loadDates(currentMonth);
    loadStats();
</script>
{% endblock %}