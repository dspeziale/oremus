{% extends "base.html" %}

{% block content %}
<div class="row">
	<div class="col-md-8">
		<div class="card">
			<div class="card-header">
				<h4 class="card-title">
					<i class="fas fa-user mr-2"></i>Dettagli Utente
				</h4>
			</div>
			<div class="card-body">
				{% if user %}
				<div class="row">
					<div class="col-md-3 text-center mb-3">
						<img src="{{ user.avatar_url if user.avatar_url else url_for('static', filename='img/profile.jpg') }}" alt="Avatar" class="rounded-circle" style="width: 150px; height: 150px; object-fit: cover;">
					</div>
					<div class="col-md-9">
						<div class="mb-3">
							<label class="font-weight-bold">Nome</label>
							<p>{{ user.nome }}</p>
						</div>
						<div class="mb-3">
							<label class="font-weight-bold">Email</label>
							<p>{{ user.email }}</p>
						</div>
						<div class="mb-3">
							<label class="font-weight-bold">Telefono</label>
							<p>{{ user.telefono if user.telefono else 'Non fornito' }}</p>
						</div>
						<div class="mb-3">
							<label class="font-weight-bold">Ruolo</label>
							<p>
								{% if user.ruolo == 'admin' %}
									<span class="badge badge-danger">Amministratore</span>
								{% elif user.ruolo == 'moderator' %}
									<span class="badge badge-warning">Moderatore</span>
								{% else %}
									<span class="badge badge-primary">Utente</span>
								{% endif %}
							</p>
						</div>
					</div>
				</div>

				<hr>

				<div class="row">
					<div class="col-md-6 mb-3">
						<label class="font-weight-bold">Data Registrazione</label>
						<p>{{ user.data_registrazione if user.data_registrazione else 'N/A' }}</p>
					</div>
					<div class="col-md-6 mb-3">
						<label class="font-weight-bold">Ultimo Accesso</label>
						<p>{{ user.ultimo_accesso if user.ultimo_accesso else 'Mai' }}</p>
					</div>
				</div>

				<div class="row">
					<div class="col-md-6 mb-3">
						<label class="font-weight-bold">Stato</label>
						<p>
							{% if user.is_active %}
								<span class="badge badge-success">Attivo</span>
							{% else %}
								<span class="badge badge-secondary">Inattivo</span>
							{% endif %}
						</p>
					</div>
					<div class="col-md-6 mb-3">
						<label class="font-weight-bold">Verificato</label>
						<p>
							{% if user.is_verified %}
								<span class="badge badge-success">Si</span>
							{% else %}
								<span class="badge badge-warning">No</span>
							{% endif %}
						</p>
					</div>
				</div>

				{% else %}
				<div class="alert alert-warning">
					<i class="fas fa-exclamation-triangle mr-2"></i>Utente non trovato.
				</div>
				{% endif %}
			</div>
		</div>
	</div>

	<div class="col-md-4">
		<div class="card">
			<div class="card-header">
				<h4 class="card-title">Azioni</h4>
			</div>
			<div class="card-body">
				{% if user %}
				<a href="{{ url_for('edit_user', user_id=user.id) }}" class="btn btn-warning btn-block mb-2">
					<i class="fas fa-edit mr-2"></i>Modifica
				</a>
				<button class="btn btn-danger btn-block" data-toggle="modal" data-target="#deleteModal">
					<i class="fas fa-trash mr-2"></i>Elimina
				</button>
				{% endif %}
				<a href="{{ url_for('users') }}" class="btn btn-secondary btn-block mt-3">
					<i class="fas fa-arrow-left mr-2"></i>Torna alla Lista
				</a>
			</div>
		</div>

		<div class="card mt-3">
			<div class="card-header">
				<h4 class="card-title">Statistiche</h4>
			</div>
			<div class="card-body">
				{% if user %}
				<div class="mb-3">
					<small class="text-muted">Ordini Totali</small>
					<p class="mb-0"><strong>{{ user.total_ordini if user.total_ordini else 0 }}</strong></p>
				</div>
				<div class="mb-3">
					<small class="text-muted">Spesa Totale</small>
					<p class="mb-0"><strong>â‚¬ {{ user.spesa_totale if user.spesa_totale else '0.00' }}</strong></p>
				</div>
				{% endif %}
			</div>
		</div>
	</div>
</div>

<!-- Delete Modal -->
<div class="modal fade" id="deleteModal" tabindex="-1" role="dialog">
	<div class="modal-dialog" role="document">
		<div class="modal-content">
			<div class="modal-header bg-danger">
				<h5 class="modal-title text-white">Elimina Utente</h5>
				<button type="button" class="close text-white" data-dismiss="modal">
					<span>&times;</span>
				</button>
			</div>
			<div class="modal-body">
				<p>Sei sicuro di voler eliminare questo utente?</p>
			</div>
			<div class="modal-footer">
				<button type="button" class="btn btn-secondary" data-dismiss="modal">Annulla</button>
				<button type="button" class="btn btn-danger" onclick="deleteUser()">Elimina</button>
			</div>
		</div>
	</div>
</div>

<script>
	function deleteUser() {
		fetch(`/users/{{ user.id }}/delete`, { method: 'POST' })
		.then(r => r.json())
		.then(d => { if(d.status === 'success') location.href = '{{ url_for("users") }}'; })
		.catch(e => alert('Errore'));
		$('#deleteModal').modal('hide');
	}
</script>

<style>
	.badge { padding: 5px 10px; }
</style>
{% endblock %}